<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>WITS – Produits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
        h1 { margin-bottom: 12px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { text-align: left; }
        .pill { display:inline-block; padding:2px 8px; border-radius:12px; background:#eee; }
        form { display:flex; gap:8px; margin: 16px 0; flex-wrap: wrap; }
        input, select, button { padding: 8px; }
    </style>
</head>
<body>
<h1>WITS – Liste des produits</h1>

<form id="addForm">
    <input name="name" placeholder="Nom du produit" required />
    <input name="quantity" type="number" placeholder="Quantité" min="0" required />
    <input name="product_category" placeholder="Catégorie" />
    <button type="submit">Ajouter</button>
</form>

<table id="tbl">
    <thead>
    <tr>
        <th>ID</th><th>Nom</th><th>Qté</th><th>Catégorie</th><th>Actions</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    const API = '/api';

    async function load() {
        const r = await fetch(`${API}/products`);
        const data = await r.json();
        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = '';
        data.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${p.product_id}</td>
          <td>${p.product_name}</td>
          <td>${p.product_quantity}</td>
          <td><span class="pill">${p.product_category ?? ''}</span></td>
          <td>
            <button data-id="${p.product_id}" class="in">+1</button>
            <button data-id="${p.product_id}" class="out">-1</button>
          </td>`;
            tbody.appendChild(tr);
        });
    }

    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('in') || e.target.classList.contains('out')) {
            const id = e.target.getAttribute('data-id');
            const type = e.target.classList.contains('in') ? 'IN' : 'OUT';
            const r = await fetch(`${API}/movements`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ movement_type: type, product_id: Number(id), movement_quantity: 1 })
            });
            if (!r.ok) {
                const err = await r.json().catch(()=>({error:'Erreur'}));
                alert(err.error || 'Erreur');
            }
            await load();
        }
    });

    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const payload = {
            name: form.name.value,
            quantity: Number(form.quantity.value),
            product_category: form.product_category.value || null
        };
        const r = await fetch(`${API}/products`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) {
            const err = await r.json().catch(()=>({error:'Erreur'}));
            alert(err.error || 'Erreur');
        } else {
            form.reset();
            await load();
        }
    });

    load();
</script>
</body>
</html>
